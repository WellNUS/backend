<!DOCTYPE html>
<html lang="en">
    <head>
        <title>Chat</title>
        <script type="text/javascript">
            window.onload = function () {
                var conn;
                var msg = document.getElementById("msg");
                var log = document.getElementById("log");
                var groupID = window.location.pathname.match(/[0-9][0-9]*/).map(parseInt)[0]
                var loaded = false

                function appendLog(item) {
                    var doScroll = log.scrollTop > log.scrollHeight - log.clientHeight - 1;
                    log.appendChild(item);
                    if (doScroll) {
                        log.scrollTop = log.scrollHeight - log.clientHeight;
                    }
                }

                function appendMessage(sender, msg) {
                    var item = document.createElement("div");
                    item.innerHTML = `${sender}: ${msg}`
                    appendLog(item)
                }
                
                fetch("http://" + document.location.host + "/message/" + groupID)
                .then(res => res.json())
                .then(data => data.forEach(message => appendMessage(message.sender.first_name, message.message.msg)))
                .catch(err => console.log(err.json()))

                document.getElementById("form").onsubmit = function () {
                    if (!conn) {
                        return false;
                    }
                    if (!msg.value) {
                        return false;
                    }
                    conn.send(msg.value);
                    msg.value = "";
                    return false;
                };

                if (window["WebSocket"]) {
                    conn = new WebSocket("ws://" + document.location.host + "/ws/" + groupID);
                    conn.onclose = function (evt) {
                        var item = document.createElement("div");
                        item.innerHTML = "<b>Connection closed.</b>";
                        appendLog(item);
                    };
                    conn.onmessage = function (evt) {
                        const { sender, message } = JSON.parse(evt.data)
                        appendMessage(sender.first_name, message.msg)
                    };
                } else {
                    var item = document.createElement("div");
                    item.innerHTML = "<b>Your browser does not support WebSockets.</b>";
                    appendLog(item);
                }
            };
        </script>
        <style type="text/css">
            #log {
                border: 1px solid black;
                height: 30em;
                margin: 0;
                padding: 0.5em 0.5em 0.5em 0.5em;
                overflow-y: auto;
            }

            #form {
                padding: 0 0.5em 0 0.5em;
                margin: 0;
                width: 100%;
            }
        </style>
    </head>

    <body>
        <a href="/testing/group">Go back to groups</a>
        <div id="log"></div>
        <form id="form">
            <input type="submit" value="Send" />
            <input type="text" id="msg" size="64" autofocus />
        </form>
        <h2> Group {{ .groupWithUsers.Group.ID }}</h2>
        <div>
            <div>GroupName: {{ .groupWithUsers.Group.GroupName }}</div>
            <div>GroupDescription: {{ .groupWithUsers.Group.GroupDescription }}</div>
            <div>Category: {{ .groupWithUsers.Group.Category}}</div>
            <div>OwnerID: {{ .groupWithUsers.Group.OwnerID }}</div>
        </div>
        <h2> Users : </h2>
        {{ range .groupWithUsers.Users }}
            <div>
                <div>ID: {{.ID}}</div>
                <div>FirstName: {{.FirstName}}</div>
                <div>LastName: {{.LastName}}</div>
                <div>Gender: {{.Gender}}</div>
                <div>Faculty: {{.Faculty}}</div>
                <div>Email: {{.Email}}</div>
                <div>UserRole: {{.UserRole}}</div>
                <div>PasswordHash: {{.PasswordHash}}</div>
            </div>
            <br>
        {{ end }}
    </body>
</html>